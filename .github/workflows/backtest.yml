name: Freqtrade Backtest

on:
  push:
    branches:
      - main
    paths:
      - '**.py'
      - '**.json'
      - '.github/workflows/**'
  workflow_dispatch:  # allows manual trigger from the Actions tab

jobs:
  backtest:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install "freqtrade==2025.12" ccxt ft-pandas-ta
          pip install https://github.com/freqtrade/technical/archive/refs/heads/master.zip

      - name: Initialize Freqtrade user data
        run: |
          freqtrade create-userdir --userdir user_data
          mkdir -p user_data/strategies
          cp RSIBB_Momentum_Pro.py user_data/strategies/

      - name: Add config file
        run: |
          cp config.json user_data/

      - name: Download historical data
        run: |
          freqtrade download-data --exchange binanceus --pairs BTC/USDT ETH/USDT --timeframes 1h --days 90

      - name: Run backtesting
        run: |
          freqtrade backtesting --strategy RSIBB_Momentum_Pro --export trades

      - name: Save backtest results
        run: |
          mkdir -p results
          cp user_data/backtest_results/backtest-result.json results/ || true
          cp user_data/backtest_results/backtest-result.html results/ || true

      - name: Upload backtest artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backtest-report
          path: results/
     
      - name: Notify via Discord
        if: always()  # run even if previous step failed
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            STATUS="✅ Backtest completed successfully!"
          else
            STATUS="❌ Backtest failed — check logs."
          fi

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"content\": \"${STATUS}\n**Repo:** $GITHUB_REPOSITORY\n**Run:** $GITHUB_RUN_NUMBER\n[View Workflow Logs]($GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID)\"}" \
               ${{ secrets.DISCORD_WEBHOOK }}

