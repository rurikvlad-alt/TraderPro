name: Freqtrade Backtest

on:
  push:
    branches:
      - main
  workflow_dispatch:  # allows manual trigger from the Actions tab
  workflow_dispatch:

jobs:
  backtest:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install "freqtrade==2025.12" ccxt
          pip install https://files.pythonhosted.org/packages/51/83/19efdb34b91b3f8300f1e5b3294baf14e0378c41edb2d7d11815e8d27d06/pandas_ta-0.3.14b0-py3-none-any.whl
          pip install https://github.com/freqtrade/technical/archive/refs/heads/master.zip

      - name: Initialize Freqtrade user data
        run: |
          freqtrade create-userdir --userdir user_data
          mkdir -p user_data/strategies
          cp RSIBB_Momentum_Pro.py user_data/strategies/

      - name: Add config file
        run: |
          cp config.json user_data/

      - name: Download historical data
        run: |
          freqtrade download-data --exchange binanceus --pairs BTC/USDT ETH/USDT --timeframes 1h --days 90

      - name: Run backtesting
        run: |
          freqtrade backtesting --strategy RSIBB_Momentum_Pro --export trades

      - name: Save backtest results
        run: |
          mkdir -p results
          cp user_data/backtest_results/backtest-result.json results/ || true
          cp user_data/backtest_results/backtest-result.html results/ || true

      - name: Upload backtest artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backtest-report
          path: results/
